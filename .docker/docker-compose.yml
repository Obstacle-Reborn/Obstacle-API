name: records
services:
  nginx:
    image: jonasal/nginx-certbot:latest
    volumes:
      - nginx-ssl:${NGINX_SSL}
      - ./nginx/templates:/etc/nginx/templates:ro
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    environment:
      CERTBOT_EMAIL: ${CERTBOT_EMAIL}
      NGINX_HOST: ${RECORDS_API_HOST}
      RECORDS_API_PORT: ${RECORDS_API_PORT}
      WEBSITE_PORT: ${WEBSITE_PORT}
    networks:
      - nginx-side
    depends_on:
      - backend
      - website
      - adminer

  website:
    build:
      context: ../
      dockerfile: ./.docker/website/Dockerfile
      args:
        WEBSITE_PORT: ${WEBSITE_PORT}
    environment:
      NODE_ENV: development
      WEBSITE_PORT: ${WEBSITE_PORT}
    expose:
      - "${WEBSITE_PORT}"
    networks:
      - nginx-side
    depends_on:
      - backend

  backend:
    build:
      context: ../
      target: development
      dockerfile: ./.docker/backend/Dockerfile
      args:
        RECORDS_API_PORT: ${RECORDS_API_PORT}
    environment:
      RECORDS_MP_APP_CLIENT_ID_FILE: /run/secrets/mp_id
      RECORDS_MP_APP_CLIENT_SECRET_FILE: /run/secrets/mp_secret
      RECORDS_API_PORT: ${RECORDS_API_PORT}
      RECORDS_API_TOKEN_TTL: ${RECORDS_API_TOKEN_TTL}
      RECORDS_API_HOST: ${RECORDS_API_HOST}
      DATABASE_URL: /run/secrets/db_url
      REDIS_URL: redis://redis:6379/
      GQL_ENDPOINT: /api/graphql
    expose:
      - "${RECORDS_API_PORT}"
    networks:
      - redis-side
      - db-side
      - nginx-side
    volumes:
      - ../game_api/src/:/records/src/
      - backend-cache:/records/target
    depends_on:
      - db
      - redis
    secrets:
      - mp_id
      - mp_secret
      - db_url

  db:
    image: mariadb
    restart: always
    environment:
      MARIADB_DATABASE_FILE: /run/secrets/db_db
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/db_root_pw
      MARIADB_USER_FILE: /run/secrets/db_user
      MARIADB_PASSWORD_FILE: /run/secrets/db_pw
    networks:
      - db-side
    expose:
      - "3306"
    secrets:
      - db_db
      - db_root_pw
      - db_user
      - db_pw
    volumes:
      - ./db/entrypoint:/docker-entrypoint-initdb.d/
      - db-data:/var/lib/mysql

  adminer:
    image: adminer
    restart: always
    networks:
      - db-side
      - nginx-side
    expose:
      - "8080"

  redis:
    image: redis:alpine
    restart: always
    networks:
      - redis-side
    expose:
      - "6379"

networks:
  redis-side: {}
  db-side: {}
  nginx-side: {}

volumes:
  nginx-ssl: {}
  backend-cache: {}
  db-data: {}

secrets:
  mp_id:
    file: ./backend/mp_id
  mp_secret:
    file: ./backend/mp_secret
  db_url:
    file: ./backend/db_url
  db_db:
    file: ./db/db_db
  db_root_pw:
    file: ./db/db_root_pw
  db_user:
    file: ./db/db_user
  db_pw:
    file: ./db/db_pw
